name: CI/CD Pipeline - Triple Personality Video API

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ğŸ—¡ï¸ Noel's Combat Phase: Quality Assurance
  quality-check:
    name: ğŸ—¡ï¸ Quality Assurance (Noel)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Noel's Syntax Validation (Rule 3.4)
        run: |
          echo "ğŸ—¡ï¸ Noel: Running TypeScript syntax validation..."
          npx tsc --noEmit
          echo "âœ… Noel: Syntax validation PASSED."

      - name: ğŸ“ Noel's ESLint Check
        run: |
          echo "ğŸ—¡ï¸ Noel: Running ESLint analysis..."
          npm run lint
          echo "âœ… Noel: ESLint PASSED."

      - name: ğŸ¨ Noel's Prettier Format Check
        run: |
          echo "ğŸ—¡ï¸ Noel: Checking code formatting..."
          npx prettier --check "src/**/*.ts"
          echo "âœ… Noel: Format check PASSED."

  # ğŸ¾ Neko-Arc's Testing Phase: Unit & E2E Tests
  test:
    name: ğŸ¾ Testing Suite (Neko-Arc)
    runs-on: ubuntu-latest
    needs: quality-check

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Neko's Unit Tests
        run: |
          echo "ğŸ¾ Neko-Arc: Running unit tests, nyaa~!"
          npm run test
          echo "âœ… Neko-Arc: Unit tests PASSED, desu~!"

      - name: ğŸ§ª Neko's E2E Tests
        run: |
          echo "ğŸ¾ Neko-Arc: Running E2E tests, nyaa~!"
          npm run test:e2e
          echo "âœ… Neko-Arc: E2E tests PASSED, desu~!"

      - name: ğŸ“Š Neko's Test Coverage
        run: |
          echo "ğŸ¾ Neko-Arc: Generating test coverage report..."
          npm run test:cov
          echo "âœ… Neko-Arc: Coverage report generated!"

      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: triple-personality-coverage
          fail_ci_if_error: false

  # ğŸ­ Mario's Build Phase: Theatrical Compilation
  build:
    name: ğŸ­ Build Verification (Mario)
    runs-on: ubuntu-latest
    needs: test

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Mario's Grand Compilation
        run: |
          echo "ğŸ­ Mario: BEHOLD! The grand compilation begins!"
          npm run build
          echo "âœ… Mario: Build MAGNIFICENT! The marionettes are compiled!"

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.node-version }}
          path: dist/
          retention-days: 7

  # ğŸ”’ Security Audit Phase
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Run npm audit
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level=moderate
          echo "âœ… Security audit complete."

  # ğŸš€ Deploy Phase (Future: Vercel/AWS/Docker)
  deploy:
    name: ğŸš€ Deployment (Production)
    runs-on: ubuntu-latest
    needs: [quality-check, test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ­ Mario's Deployment Announcement
        run: |
          echo "ğŸ­ Mario: THE CURTAIN RISES on PRODUCTION!"
          echo "ğŸ­ Mario: Deployment to production environment begins!"

      - name: ğŸš€ Deployment Placeholder
        run: |
          echo "ğŸš€ Deployment step placeholder"
          echo "Future: Add Vercel, AWS, or Docker deployment here"
          echo "âœ… Deployment preparation complete"

  # ğŸ‰ Success Notification
  success:
    name: ğŸ‰ Pipeline Success
    runs-on: ubuntu-latest
    needs: [quality-check, test, build, security]
    if: success()

    steps:
      - name: ğŸ‰ ALL THREE PERSONALITIES CELEBRATE
        run: |
          echo "ğŸ¾ Neko-Arc: NYAA NYA NYA! Pipeline PASSED, desu~!"
          echo "ğŸ­ Mario: MAGNIFICENT! A standing ovation for our CI/CD performance!"
          echo "ğŸ—¡ï¸ Noel: Tch. Acceptable execution. All quality gates passed."
          echo ""
          echo "âœ… ALL CHECKS PASSED âœ…"
          echo "ğŸ¾ğŸ­ğŸ—¡ï¸ Triple Personality Video API - Ready for deployment!"
